import React, { useState, useEffect } from "react";
import { BrowserRouter as Router, Routes, Route, Link } from "react-router-dom";              <Link to="/group-delivery" className="btn btn-success btn-sm">
                üë•
              </Link>mport CartPage from "./CartPage";
import CheckoutPage from "./CheckOutPage";
import RestaurantDetail from "./RestaurantDetail";
import GroupDelivery from "./GroupDelivery";
import GroupDeliveryConfirmation from "./GroupDeliveryConfirmation";
import UserProfile from "./UserProfile";
import { AuthProvider, useAuth, LoginModal, SignupModal } from "../contexts/AuthContext";
import "./MarketplaceModern.css";
import "./MarketplaceModern.css";

function Marketplace() {
  return (
    <AuthProvider>
      <MarketplaceContent />
    </AuthProvider>
  );
}

function MarketplaceContent() {
  const [foods, setFoods] = useState([]);
  const [filteredFoods, setFilteredFoods] = useState([]);
  const [restaurants] = useState([
    { id: 1, name: "Campus Kitchen", specialty: "African Dishes", rating: 4.6, deliveryTime: "20‚Äì30 min", fee: "Free", image: "https://images.unsplash.com/photo-1600891964599-f61ba0e24092?w=800" },
    { id: 2, name: "Foodie's Hub", specialty: "Fast Food & Burgers", rating: 4.3, deliveryTime: "15‚Äì25 min", fee: "$0.99", image: "https://images.unsplash.com/photo-1550547660-d9450f859349?w=800" }
  ]);
  const [studentCooks] = useState([
    { id: 1, name: "Sarah Nalule", dish: "Yummy Meat Stew", contact: "0771 234567", rating: 4.7, price: "UGX 12,000", image: "https://images.unsplash.com/photo-1626108846582-e92033b90b16?w=800" },
    { id: 2, name: "Brian Kato", dish: "FCI Chapati Combo", contact: "0706 998877", rating: 4.5, price: "UGX 8,000", image: "https://images.unsplash.com/photo-1708782343717-be4ea260249a?w=800" }
  ]);
  const [cart, setCart] = useState([]);
  const [favorites, setFavorites] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedCategory, setSelectedCategory] = useState("All");
  const [showLoginModal, setShowLoginModal] = useState(false);
  const [showSignupModal, setShowSignupModal] = useState(false);

  useEffect(() => {
    const fetchFoods = async () => {
      try {
        const res = await fetch("https://www.themealdb.com/api/json/v1/1/search.php?s=");
        const data = await res.json();
        setFoods(data.meals || []);
        setFilteredFoods(data.meals || []);
      } catch (err) {
        console.error(err);
      } finally {
        setLoading(false);
      }
    };
    fetchFoods();
  }, []);

  // Search functionality - receives filtered results from EnhancedSearch
  const handleSearch = (filteredResults) => {
    setFilteredFoods(filteredResults);
  };

  const addToCart = (item) => {
    const exists = cart.find(i => i.idMeal === item.idMeal);
    if (exists) {
      setCart(cart.map(i => i.idMeal === item.idMeal ? { ...i, quantity: i.quantity + 1 } : i));
    } else {
      setCart([...cart, { ...item, quantity: 1 }]);
    }
  };

  const toggleFavorite = (item) => {
    const exists = favorites.find(i => i.idMeal === item.idMeal);
    if (exists) {
      setFavorites(favorites.filter(i => i.idMeal !== item.idMeal));
    } else {
      setFavorites([...favorites, item]);
    }
  };

  return (
    <Router>
      <div className="app-container">
        <Navbar 
          cartCount={cart.reduce((sum, i) => sum + i.quantity, 0)} 
          onLoginClick={() => setShowLoginModal(true)}
          onSignupClick={() => setShowSignupModal(true)}
        />
        <Routes>
          <Route path="/" element={
            <Home
              foods={foods}
              filteredFoods={filteredFoods}
              restaurants={restaurants}
              cooks={studentCooks}
              addToCart={addToCart}
              favorites={favorites}
              toggleFavorite={toggleFavorite}
              loading={loading}
              selectedCategory={selectedCategory}
              setSelectedCategory={setSelectedCategory}
              onSearch={handleSearch}
            />
          } />
          <Route path="/cart" element={<CartPage cart={cart} setCart={setCart} />} />
          <Route path="/checkout" element={<CheckoutPage cart={cart} />} />
          <Route path="/group-delivery" element={<GroupDelivery cart={cart} />} />
          <Route path="/group-delivery-confirmation" element={<GroupDeliveryConfirmation />} />
          <Route path="/profile" element={<UserProfile />} />
          <Route path="/restaurant/:id" element={<RestaurantDetail restaurants={restaurants} addToCart={addToCart} />} />
        </Routes>
        
        {/* Auth Modals */}
        <LoginModal isOpen={showLoginModal} onClose={() => setShowLoginModal(false)} />
        <SignupModal isOpen={showSignupModal} onClose={() => setShowSignupModal(false)} />
        
        <Footer />
      </div>
    </Router>
  );
}

// ===== Navbar =====
function Navbar({ cartCount, onLoginClick, onSignupClick }) {
  const { user, logout } = useAuth();

  return (
    <nav className="navbar-fixed">
      <div className="navbar-content">
        <h1 className="logo">MUST E-Cafeteria</h1>
        <div className="nav-actions">
          {user ? (
            <>
              <Link to="/profile" className="btn btn-ghost btn-sm">
                üë§
              </Link>
              <Link to="/group-delivery" className="btn btn-success btn-sm">
                ÔøΩ
              </Link>
              <button onClick={logout} className="btn btn-ghost btn-sm">
                Logout
              </button>
            </>
          ) : (
            <>
              <button onClick={onLoginClick} className="btn btn-outline btn-sm">
                Login
              </button>
              <button onClick={onSignupClick} className="btn btn-primary btn-sm">
                Sign Up
              </button>
            </>
          )}
          <Link to="/cart" className="btn btn-primary btn-sm cart-btn">
            üõí {cartCount > 0 && <span className="cart-count">{cartCount}</span>}
          </Link>
        </div>
      </div>
    </nav>
  );
}

// ===== Home =====
function Home({ foods, filteredFoods, restaurants, cooks, addToCart, favorites, toggleFavorite, loading, selectedCategory, setSelectedCategory, onSearch }) {
  const displayFoods = selectedCategory === "All" ? filteredFoods : filteredFoods.filter(f => f.strCategory === selectedCategory);
  const categories = ["All", "Breakfast", "Main Course", "Dessert"];

  return (
    <div className="home-page">
      {/* Modern Hero Section */}
      <div className="hero-section">
        <div className="hero-content">
          <h1 className="hero-title">Fresh Meals, Delivered Fast</h1>
          <p className="hero-subtitle">Discover amazing food from campus restaurants and student chefs</p>
        </div>
      </div>

      {/* Simple Search */}
      <div className="simple-search">
        <div className="search-container">
          <span className="search-icon">üîç</span>
          <input 
            type="text" 
            placeholder="Search for food, restaurants..."
            className="search-input"
            onChange={(e) => {
              const searchTerm = e.target.value.toLowerCase();
              const filtered = foods.filter(food => 
                food.strMeal.toLowerCase().includes(searchTerm) ||
                food.strCategory.toLowerCase().includes(searchTerm)
              );
              onSearch(filtered);
            }}
          />
        </div>
      </div>

      <p className="delivery-info">üìç Delivering to <strong>Main Campus</strong></p>

      {/* Categories */}
      <div className="categories-scroll">
        {categories.map(cat => (
          <button
            key={cat}
            className={`cat-chip ${selectedCategory === cat ? "active" : ""}`}
            onClick={() => setSelectedCategory(cat)}
          >
            {cat}
          </button>
        ))}
      </div>

      {/* Popular Meals */}
      <section className="section">
        <h2 className="section-title">Popular Right Now</h2>
        <div className="meal-grid">
          {loading
            ? Array(6).fill(0).map((_, i) => <SkeletonCard key={i} />)
            : displayFoods.slice(0, 12).map(food => (
                <MealCard
                  key={food.idMeal}
                  food={food}
                  addToCart={addToCart}
                  isFavorite={favorites.some(f => f.idMeal === food.idMeal)}
                  toggleFavorite={() => toggleFavorite(food)}
                />
              ))
          }
        </div>
      </section>

      {/* Restaurants */}
      <section className="section">
        <h2 className="section-title">Top Restaurants</h2>
        <div className="restaurant-grid">
          {restaurants.map(r => (
            <Link to={`/restaurant/${r.id}`} key={r.id} className="restaurant-card">
              <img src={r.image} alt={r.name} loading="lazy" />
              <div className="restaurant-info">
                <h3>{r.name}</h3>
                <p className="specialty">{r.specialty}</p>
                <div className="restaurant-meta">
                  <span className="rating">‚òÖ {r.rating}</span>
                  <span>‚Ä¢ {r.deliveryTime}</span>
                  <span>‚Ä¢ {r.fee} delivery</span>
                </div>
              </div>
            </Link>
          ))}
        </div>
      </section>

      {/* Student Cooks */}
      <section className="section">
        <h2 className="section-title">Student Chefs Near You</h2>
        <div className="cooks-grid">
          {cooks.map(cook => (
            <div key={cook.id} className="cook-card">
              <img src={cook.image} alt={cook.name} />
              <div className="cook-info">
                <h4>{cook.name}</h4>
                <p className="dish">{cook.dish}</p>
                <div className="cook-meta">
                  <span>‚òÖ {cook.rating}</span>
                  <span className="price">{cook.price}</span>
                </div>
                <button className="btn btn-primary contact-btn">üì± Message</button>
              </div>
            </div>
          ))}
        </div>
      </section>
    </div>
  );
}

function MealCard({ food, addToCart, isFavorite, toggleFavorite }) {
  // Generate consistent price based on food ID
  const getPrice = (id) => {
    const hash = id.split('').reduce((a, b) => {
      a = ((a << 5) - a) + b.charCodeAt(0);
      return a & a;
    }, 0);
    return (Math.abs(hash) % 20 + 10);
  };

  return (
    <div className="meal-card">
      <div className="image-wrapper">
        <img src={food.strMealThumb} alt={food.strMeal} loading="lazy" />
        <button onClick={toggleFavorite} className="fav-btn">
          {isFavorite ? "‚ù§Ô∏è" : "‚ô°"}
        </button>
      </div>
      <div className="meal-details">
        <h3>{food.strMeal}</h3>
        <p className="cuisine">{food.strArea} ‚Ä¢ {food.strCategory}</p>
        <div className="meal-actions">
          <span className="price">UGX {getPrice(food.idMeal)}k</span>
          <button onClick={() => addToCart(food)} className="btn btn-primary btn-icon add-btn">
            ‚ûï
          </button>
        </div>
      </div>
    </div>
  );
}

function SkeletonCard() {
  return <div className="skeleton-card"></div>;
}

// ===== Footer =====
function Footer() {
  return (
    <footer className="footer">
      <p>¬© {new Date().getFullYear()} MUST E-Cafeteria ‚Ä¢ Made by <a href="https://mubirueltonfelix.com" target="_blank" rel="noreferrer">Mubiru Elton Felix</a></p>
    </footer>
  );
}

export default Marketplace;
